name: Build and Upload Kali Image to DigitalOcean

on:
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download Kali Image
        run: wget https://kali.download/cloud-images/kali-2024.3/kali-linux-2024.3-cloud-genericcloud-amd64.tar.xz

      - name: Extract Image
        run: tar -xvf kali-linux-2024.3-cloud-genericcloud-amd64.tar.xz

      - name: Compress Image to gzip
        run: gzip -c disk.raw > disk.raw.gz

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: kali-image-$(date +%Y%m%d)
          release_name: Kali Linux Image $(date +%Y%m%d)
          draft: false
          prerelease: false

      - name: Upload Compressed Image to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./disk.raw.gz
          asset_name: disk.raw.gz
          asset_content_type: application/gzip

      - name: Upload to DigitalOcean
        env:
          DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          REGION: ${{ secrets.REGION }}
        run: |
          curl -X POST "https://api.digitalocean.com/v2/images" \
          -H "Authorization: Bearer $DIGITALOCEAN_ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{
                \"name\": \"Kali from GitHub Action\",
                \"url\": \"https://github.com/${{ github.repository }}/releases/download/kali-image-$(date +%Y%m%d)/disk.raw.gz\",
                \"distribution\": \"Debian\",
                \"region\": \"$REGION\",
                \"architecture\": \"x86_64\",
                \"description\": \"Custom Kali Linux image\",
                \"tags\": [\"kali\"]
              }"
